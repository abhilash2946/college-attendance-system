{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
  <div class="row">
    <div class="col-md-10 mx-auto">
      {% if not students and branch %}
        <!-- No students found -->
        <div class="card shadow-lg border-0">
          <div class="card-header bg-danger text-white py-4">
            <h2 class="mb-0">âŒ No Students Found</h2>
          </div>
          <div class="card-body p-5">
            <p style="font-size: 18px;">No students found for <strong>{{ branch }} / Year {{ year }} / Section {{ section }}</strong></p>
            <a href="{{ url_for('faculty.dashboard') }}" class="btn btn-secondary btn-lg mt-3">â† Back to Dashboard</a>
          </div>
        </div>
      {% elif students %}
        <!-- Student attendance list -->
        <div class="card shadow-lg border-0">
          <div class="card-header bg-success text-white py-4">
            <h2 class="mb-0">ğŸ“ Mark Attendance - {{ branch }} | Year {{ year }} | Section {{ section }}</h2>
            <small style="font-size: 16px;">Date: <strong>{{ today }}</strong></small>
          </div>
          <div class="card-body p-5">
            <form method="post">
              <input type="hidden" name="branch" value="{{ branch }}">
              <input type="hidden" name="year" value="{{ year }}">
              <input type="hidden" name="section" value="{{ section }}">
              <input type="hidden" name="date" value="{{ today }}">

              <div class="alert alert-primary p-4" role="alert" style="font-size: 16px;">
                <strong>ğŸ“Œ Note:</strong> All students are marked <span class="badge bg-success" style="font-size: 14px;">Present</span> by default. 
                Check the box for students who are <span class="badge bg-danger" style="font-size: 14px;">Absent</span>.
              </div>

              <div class="table-responsive" style="margin: 30px 0;">
                <table class="table table-striped table-hover table-bordered" style="font-size: 16px;">
                  <thead class="table-dark">
                    <tr style="font-size: 17px;">
                      <th style="width: 8%;">Absent?</th>
                      <th style="width: 15%;">ğŸ“Œ Roll No.</th>
                      <th style="width: 50%;">ğŸ‘¤ Student Name</th>
                      <th style="width: 27%;">Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for s in students %}
                    <tr class="student-row" style="height: 50px;">
                      <td class="text-center">
                        <input type="checkbox" name="absent" value="{{ s.roll_no }}" class="absent-checkbox" style="width: 20px; height: 20px;">
                      </td>
                      <td style="font-size: 16px;"><strong>{{ s.roll_no }}</strong></td>
                      <td style="font-size: 16px;">{{ s.name }}</td>
                      <td>
                        <span class="status-badge badge bg-success present-status" style="font-size: 14px; padding: 8px 12px;">âœ“ Present</span>
                        <span class="status-badge badge bg-danger absent-status" style="display:none; font-size: 14px; padding: 8px 12px;">âœ— Absent</span>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>

              <div class="row mt-4">
                <div class="col-md-6">
                  <div class="card bg-light border-primary" style="padding: 20px;">
                    <h5 class="card-title" style="font-size: 18px;">ğŸ“Š Attendance Summary</h5>
                    <p class="mb-2" style="font-size: 17px;">Total Students: <strong>{{ students|length }}</strong></p>
                    <p class="mb-2" style="font-size: 17px; color: green;">âœ“ Present: <strong id="presentCount" style="font-size: 20px;">{{ students|length }}</strong></p>
                    <p class="mb-0" style="font-size: 17px; color: red;">âœ— Absent: <strong id="absentCount" style="font-size: 20px;">0</strong></p>
                  </div>
                </div>
                <div class="col-md-6">
                  <a href="{{ url_for('faculty.dashboard') }}" class="btn btn-secondary btn-lg w-100 mb-3" style="font-size: 16px; padding: 15px;">â† Cancel</a>
                  <button type="submit" class="btn btn-success btn-lg w-100" style="font-size: 16px; padding: 15px;">âœ“ Submit Attendance</button>
                </div>
              </div>
            </form>

            <script>
              function updateSummary() {
                const total = {{ students|length }};
                const absent = document.querySelectorAll('.absent-checkbox:checked').length;
                const present = total - absent;
                document.getElementById('presentCount').textContent = present;
                document.getElementById('absentCount').textContent = absent;

                document.querySelectorAll('.student-row').forEach(row => {
                  const checkbox = row.querySelector('.absent-checkbox');
                  const presentBadge = row.querySelector('.present-status');
                  const absentBadge = row.querySelector('.absent-status');
                  if (checkbox.checked) {
                    presentBadge.style.display = 'none';
                    absentBadge.style.display = 'inline-block';
                  } else {
                    presentBadge.style.display = 'inline-block';
                    absentBadge.style.display = 'none';
                  }
                });
              }

              document.querySelectorAll('.absent-checkbox').forEach(cb => {
                cb.addEventListener('change', updateSummary);
              });
            </script>
          </div>
        </div>
      {% else %}
        <!-- Initial form to enter class details -->
        <div class="card shadow-lg border-0">
          <div class="card-header bg-success text-white py-4">
            <h2 class="mb-0">ğŸ“ Mark Attendance</h2>
          </div>
          <div class="card-body p-5">
            <p class="text-muted mb-5" style="font-size: 17px;">ğŸ“Œ Select your class details to proceed with attendance marking:</p>
            
            <form method="get">
              <div class="row g-4">
                <div class="col-md-6">
                  <label class="form-label fw-bold" style="font-size: 16px;">ğŸ¢ Branch <span class="text-danger">*</span></label>
                  <input type="text" name="branch" class="form-control form-control-lg" placeholder="e.g., CSE, ECE, MECH" required style="font-size: 16px; padding: 15px;">
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-bold" style="font-size: 16px;">ğŸ“Š Year <span class="text-danger">*</span></label>
                  <input type="number" name="year" min="1" max="5" class="form-control form-control-lg" placeholder="1-5" required style="font-size: 16px; padding: 15px;">
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-bold" style="font-size: 16px;">ğŸ‘¥ Section <span class="text-danger">*</span></label>
                  <input type="text" name="section" class="form-control form-control-lg" placeholder="A, B, C" required style="font-size: 16px; padding: 15px;">
                </div>
              </div>

              <div class="alert alert-info mt-5 p-4" role="alert" style="font-size: 16px;">
                <strong>â„¹ï¸ How to use:</strong><br>
                1. Enter the branch name (e.g., CSE)<br>
                2. Enter the year/semester (1, 2, 3, etc.)<br>
                3. Enter the section letter (A, B, C, etc.)<br>
                4. Click <strong>Next â†’</strong> to see all students in that class
              </div>

              <div class="row mt-5">
                <div class="col-md-12">
                  <button type="submit" class="btn btn-success btn-lg w-100" style="font-size: 18px; padding: 15px;">Next â†’ Fetch Students</button>
                </div>
              </div>
            </form>

            <hr class="my-4">
            <div class="text-center">
              <a href="{{ url_for('faculty.dashboard') }}" class="text-muted" style="font-size: 14px; text-decoration: none;">â† Back to Dashboard</a>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}
